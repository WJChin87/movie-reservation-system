<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Select Seats - Movie Reservation System</title>
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      .seats-container {
        margin: 20px auto;
        text-align: center;
        max-width: 1200px;
        padding: 20px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .screen {
        background: linear-gradient(to bottom, #666, #333);
        height: 15px;
        border-radius: 50%;
        margin: 20px auto;
        width: 90%;
        max-width: 800px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
      }
      .screen-text {
        text-align: center;
        color: #666;
        margin: 10px 0 30px 0;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-size: 0.9em;
      }
      .theater {
        margin: 20px auto;
        perspective: 1000px;
      }
      .seating-layout {
        transform: rotateX(12deg);
        transform-origin: 50% 0;
        margin: 20px auto;
        max-width: 1000px;
      }
      .row {
        display: flex;
        justify-content: center;
        margin: 5px 0;
        gap: 5px;
      }
      .row-label {
        width: 30px;
        text-align: right;
        padding-right: 10px;
        color: #666;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: flex-end;
      }
      .seat {
        width: 35px;
        height: 35px;
        margin: 3px;
        border-radius: 10px 10px 0 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff;
        border: 2px solid #007bff;
        color: #007bff;
        font-size: 0.8em;
        transition: all 0.3s ease;
        position: relative;
      }
      .seat.selected {
        background: #007bff;
        color: white;
        transform: scale(1.1);
        box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
      }
      .seat.occupied {
        background: #ccc;
        border-color: #999;
        cursor: not-allowed;
        color: #666;
      }
      .seat:hover:not(.occupied) {
        transform: scale(1.1);
        border-color: #0056b3;
        box-shadow: 0 0 10px rgba(0, 123, 255, 0.3);
      }
      .aisle {
        width: 20px;
      }
      .legend {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin: 30px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .legend-seat {
        width: 25px;
        height: 25px;
        border-radius: 7px 7px 0 0;
      }
      .summary {
        margin: 30px auto;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        max-width: 600px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .summary h4 {
        margin-top: 0;
        color: #333;
        font-size: 1.2em;
        margin-bottom: 15px;
      }
      .price-info {
        font-size: 1.2em;
        color: #28a745;
        font-weight: bold;
      }
      #confirmButton {
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        width: 100%;
        max-width: 200px;
        margin-top: 15px;
        transition: all 0.3s ease;
      }
      #confirmButton:hover:not(:disabled) {
        background: #218838;
        transform: translateY(-2px);
      }
      #confirmButton:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .theater-info {
        margin: 20px 0;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .theater-info h3 {
        margin: 0 0 15px 0;
        color: #333;
      }
      .theater-info p {
        margin: 5px 0;
        color: #666;
      }
      .theater-info strong {
        color: #333;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Movie Reservation System</h2>
      <nav class="nav-links">
        <a href="/movies.html">Movies</a>
        <a href="/reservations.html">My Reservations</a>
        <button onclick="logout()" class="logout-btn">Logout</button>
      </nav>

      <div class="theater-info" id="movieInfo"></div>

      <div class="seats-container">
        <div class="screen"></div>
        <p class="screen-text">SCREEN</p>
        <div class="legend">
          <div class="legend-item">
            <div class="legend-seat seat"></div>
            <span>Available</span>
          </div>
          <div class="legend-item">
            <div class="legend-seat seat selected"></div>
            <span>Selected</span>
          </div>
          <div class="legend-item">
            <div class="legend-seat seat occupied"></div>
            <span>Occupied</span>
          </div>
        </div>
        <div id="seatsGrid" class="seating-layout"></div>
      </div>

      <div class="summary">
        <h4>Booking Summary</h4>
        <p>Selected Seats: <span id="selectedSeats"></span></p>
        <p>
          Total Price:
          <span class="price-info">$<span id="totalPrice">0.00</span></span>
        </p>
        <button onclick="confirmReservation()" id="confirmButton" disabled>
          Confirm Reservation
        </button>
      </div>

      <div id="message"></div>
    </div>

    <script>
      const API_URL = "http://localhost:3000/api";
      const authToken = localStorage.getItem("token");
      const showtimeId = new URLSearchParams(window.location.search).get(
        "showtime"
      );
      let selectedSeats = new Set();
      let showtimeData = null;
      let seatPrice = 0;

      // Check authentication
      if (!authToken) {
        window.location.href = "/login.html";
      }

      // Load showtime and seat data
      document.addEventListener("DOMContentLoaded", loadShowtimeData);

      async function loadShowtimeData() {
        try {
          const [showtimeResponse, seatsResponse] = await Promise.all([
            fetch(`${API_URL}/showtimes/${showtimeId}`, {
              headers: { Authorization: `Bearer ${authToken}` },
            }),
            fetch(`${API_URL}/showtimes/${showtimeId}/seats`, {
              headers: { Authorization: `Bearer ${authToken}` },
            }),
          ]);

          showtimeData = await showtimeResponse.json();
          const seatsData = await seatsResponse.json();
          seatPrice = showtimeData.price;

          // Display movie info
          document.getElementById("movieInfo").innerHTML = `
            <h3>${showtimeData.movie.title}</h3>
            <p><strong>Date:</strong> ${new Date(
              showtimeData.start_time
            ).toLocaleDateString()}</p>
            <p><strong>Time:</strong> ${new Date(
              showtimeData.start_time
            ).toLocaleTimeString()}</p>
            <p><strong>Theater:</strong> ${showtimeData.theater.name}</p>
            <p><strong>Price per seat:</strong> $${seatPrice}</p>
          `;

          // Generate seats grid based on theater type
          generateSeatsGrid(seatsData, showtimeData.theater.type);
        } catch (error) {
          showMessage("Error loading showtime data", "error");
        }
      }

      function generateSeatsGrid(seatsData, theaterType) {
        const seatsGrid = document.getElementById("seatsGrid");
        seatsGrid.innerHTML = ""; // Clear existing content

        const totalSeats = 150;
        const seatsPerRow = 15;
        const totalRows = Math.ceil(totalSeats / seatsPerRow);

        // Create rows
        for (let row = 1; row <= totalRows; row++) {
          const rowDiv = document.createElement("div");
          rowDiv.className = "row";

          // Add row label
          const rowLabel = document.createElement("div");
          rowLabel.className = "row-label";
          rowLabel.textContent = String.fromCharCode(64 + row); // Convert to letter (A, B, C, etc.)
          rowDiv.appendChild(rowLabel);

          // Add seats
          for (let seatNum = 1; seatNum <= seatsPerRow; seatNum++) {
            // Add aisle spacing based on theater type
            const config = getTheaterConfig(theaterType);
            if (config.aisles.includes(seatNum)) {
              const aisle = document.createElement("div");
              aisle.className = "aisle";
              rowDiv.appendChild(aisle);
            }

            const seatDiv = document.createElement("div");
            const seatId = (row - 1) * seatsPerRow + seatNum;

            // Check if this seat exists in seatsData and is occupied
            const existingSeat = seatsData.find(
              (seat) =>
                seat.row_number === String.fromCharCode(64 + row) &&
                seat.seat_number === seatNum
            );

            seatDiv.className = `seat${
              existingSeat?.is_occupied ? " occupied" : ""
            }`;
            seatDiv.textContent = seatNum;
            seatDiv.dataset.seatId = existingSeat?.id || seatId;

            if (!existingSeat?.is_occupied) {
              seatDiv.onclick = () =>
                toggleSeat(seatDiv, {
                  id: existingSeat?.id || seatId,
                  row_number: String.fromCharCode(64 + row),
                  seat_number: seatNum,
                });
            }

            rowDiv.appendChild(seatDiv);
          }

          seatsGrid.appendChild(rowDiv);
        }
      }

      function getTheaterConfig(type) {
        switch (type) {
          case "VIP":
            return {
              aisles: [4, 8, 12], // Aisles after every 4 seats
            };
          case "IMAX":
            return {
              aisles: [5, 10], // Aisles after 5 and 10 seats
            };
          default: // Standard
            return {
              aisles: [7], // Aisle after 7 seats
            };
        }
      }

      function toggleSeat(seatDiv, seat) {
        const seatId = seat.id;
        if (selectedSeats.has(seatId)) {
          selectedSeats.delete(seatId);
          seatDiv.classList.remove("selected");
        } else {
          selectedSeats.add(seatId);
          seatDiv.classList.add("selected");
        }
        updateSummary();
      }

      function updateSummary() {
        const selectedSeatsDisplay = document.getElementById("selectedSeats");
        const totalPriceDisplay = document.getElementById("totalPrice");
        const confirmButton = document.getElementById("confirmButton");

        const selectedSeatsArray = Array.from(selectedSeats);
        selectedSeatsDisplay.textContent = selectedSeatsArray.length
          ? `${selectedSeatsArray.length} seat(s)`
          : "None";

        const total = selectedSeatsArray.length * seatPrice;
        totalPriceDisplay.textContent = total.toFixed(2);

        confirmButton.disabled = selectedSeatsArray.length === 0;
      }

      async function confirmReservation() {
        try {
          const selectedSeatsArray = Array.from(selectedSeats);

          const response = await fetch(`${API_URL}/reservations`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              showtime_id: showtimeId,
              seat_ids: selectedSeatsArray,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            showMessage("Reservation successful!", "success");
            setTimeout(() => {
              window.location.href = "/reservations.html";
            }, 2000);
          } else {
            showMessage(data.message || "Error making reservation", "error");
          }
        } catch (error) {
          console.error("Error:", error);
          showMessage("Error connecting to server", "error");
        }
      }

      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "/login.html";
      }

      function showMessage(message, type) {
        const messageDiv = document.getElementById("message");
        messageDiv.textContent = message;
        messageDiv.className = type;
        setTimeout(() => {
          messageDiv.textContent = "";
          messageDiv.className = "";
        }, 5000);
      }
    </script>
  </body>
</html>
