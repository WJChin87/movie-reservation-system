<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Movie Showtimes - Movie Reservation System</title>
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      .movie-header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .movie-poster {
        width: 120px;
        height: 180px;
        object-fit: cover;
        border-radius: 4px;
      }

      .movie-info h1 {
        margin: 0 0 10px 0;
        color: #333;
      }

      .movie-details {
        color: #666;
      }

      .dates-container {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        overflow-x: auto;
        padding-bottom: 10px;
      }

      .date-button {
        min-width: 120px;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s ease;
      }

      .date-button:hover {
        border-color: #007bff;
        background: #f8f9fa;
      }

      .date-button.active {
        border-color: #007bff;
        background: #007bff;
        color: white;
      }

      .date-button .day {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .date-button .date {
        font-size: 0.9em;
        color: inherit;
      }

      .showtimes-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
      }

      .showtime-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background: white;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .showtime-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .theater-name {
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
      }

      .theater-type {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 10px;
      }

      .time-price {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .time {
        font-size: 1.2em;
        font-weight: bold;
        color: #007bff;
      }

      .price {
        color: #28a745;
        font-weight: bold;
      }

      .theater-section {
        margin-bottom: 30px;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
      }

      .theater-section h3 {
        margin: 0 0 15px 0;
        color: #333;
      }

      .showtimes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
      }

      /* Scrollbar styling */
      .dates-container::-webkit-scrollbar {
        height: 8px;
      }

      .dates-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .dates-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }

      .dates-container::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <nav class="nav-links">
        <a href="/movies.html">Movies</a>
        <a href="/reservations.html">My Reservations</a>
        <button onclick="logout()" class="logout-btn">Logout</button>
      </nav>

      <div id="movieHeader" class="movie-header"></div>
      <div id="datesContainer" class="dates-container"></div>
      <div id="showtimesContainer" class="showtimes-container"></div>
    </div>

    <script>
      const API_URL = "http://localhost:3000/api";
      const authToken = localStorage.getItem("token");
      let currentMovie = null;
      let allShowtimes = [];

      // Check authentication
      if (!authToken) {
        window.location.href = "/login.html";
      }

      // Get movie ID and title from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const movieId = urlParams.get("movieId");
      const movieTitle = urlParams.get("title");

      if (!movieId || !movieTitle) {
        window.location.href = "/movies.html";
      }

      document.addEventListener("DOMContentLoaded", initialize);

      async function initialize() {
        try {
          // Load movie details
          const movieResponse = await fetch(`${API_URL}/movies/${movieId}`, {
            headers: { Authorization: `Bearer ${authToken}` },
          });
          currentMovie = await movieResponse.json();

          // Load showtimes
          const showtimesResponse = await fetch(
            `${API_URL}/showtimes?movieId=${movieId}`,
            {
              headers: { Authorization: `Bearer ${authToken}` },
            }
          );
          allShowtimes = await showtimesResponse.json();

          renderMovieHeader();
          renderDates();
          renderShowtimes(new Date().toISOString().split("T")[0]); // Show today's showtimes by default
        } catch (error) {
          console.error("Error initializing page:", error);
        }
      }

      function renderMovieHeader() {
        const header = document.getElementById("movieHeader");
        header.innerHTML = `
                <img src="${currentMovie.poster_url}" alt="${
          currentMovie.title
        }" class="movie-poster">
                <div class="movie-info">
                    <h1>${currentMovie.title}</h1>
                    <div class="movie-details">
                        <p><strong>Duration:</strong> ${
                          currentMovie.duration
                        } minutes</p>
                        <p><strong>Genre:</strong> ${
                          Array.isArray(currentMovie.genres)
                            ? currentMovie.genres.join(", ")
                            : currentMovie.genres
                        }</p>
                        <p><strong>Rating:</strong> ${currentMovie.rating}</p>
                    </div>
                </div>
            `;
      }

      function renderDates() {
        const dates = [];
        const today = new Date();

        // Generate next 5 days
        for (let i = 0; i < 5; i++) {
          const date = new Date(today);
          date.setDate(today.getDate() + i);
          dates.push({
            date: date,
            isToday: i === 0,
            isTomorrow: i === 1,
          });
        }

        const datesContainer = document.getElementById("datesContainer");
        datesContainer.innerHTML = dates
          .map((dateObj) => {
            const dateStr = dateObj.date.toISOString().split("T")[0];

            let dayLabel;
            if (dateObj.isToday) dayLabel = "Today";
            else if (dateObj.isTomorrow) dayLabel = "Tomorrow";
            else
              dayLabel = dateObj.date.toLocaleDateString("en-US", {
                weekday: "short",
              });

            return `
                    <div class="date-button ${dateObj.isToday ? "active" : ""}" 
                         onclick="selectDate('${dateStr}', this)">
                        <div class="day">${dayLabel}</div>
                        <div class="date">${dateObj.date.toLocaleDateString(
                          "en-US",
                          {
                            month: "short",
                            day: "numeric",
                          }
                        )}</div>
                    </div>
                `;
          })
          .join("");
      }

      function selectDate(dateStr, button) {
        // Update active state
        document
          .querySelectorAll(".date-button")
          .forEach((btn) => btn.classList.remove("active"));
        button.classList.add("active");

        // Render showtimes for selected date
        renderShowtimes(dateStr);
      }

      function renderShowtimes(dateStr) {
        const container = document.getElementById("showtimesContainer");

        // Filter showtimes for selected date
        const dateShowtimes = allShowtimes.filter((showtime) => {
          const showtimeDate = new Date(showtime.start_time)
            .toISOString()
            .split("T")[0];
          return showtimeDate === dateStr;
        });

        if (dateShowtimes.length === 0) {
          container.innerHTML = "<p>No showtimes available for this date.</p>";
          return;
        }

        // Group showtimes by theater type
        const showtimesByTheater = dateShowtimes.reduce((acc, showtime) => {
          const type = showtime.theater.type;
          if (!acc[type]) {
            acc[type] = [];
          }
          acc[type].push(showtime);
          return acc;
        }, {});

        // Generate HTML for each theater type
        container.innerHTML = Object.entries(showtimesByTheater)
          .map(
            ([theaterType, showtimes]) => `
            <div class="theater-section">
              <h3>${theaterType}</h3>
              <div class="showtimes-grid">
                ${showtimes
                  .sort(
                    (a, b) => new Date(a.start_time) - new Date(b.start_time)
                  )
                  .map(
                    (showtime) => `
                      <div class="showtime-card" onclick="selectShowtime(${
                        showtime.id
                      })">
                          <div class="theater-name">${
                            showtime.theater.name
                          }</div>
                          <div class="time-price">
                              <div class="time">${new Date(
                                showtime.start_time
                              ).toLocaleTimeString([], {
                                hour: "2-digit",
                                minute: "2-digit",
                              })}</div>
                              <div class="price">$${showtime.price.toFixed(
                                2
                              )}</div>
                          </div>
                      </div>
                    `
                  )
                  .join("")}
              </div>
            </div>
          `
          )
          .join("");
      }

      function selectShowtime(showtimeId) {
        window.location.href = `/seats.html?showtime=${showtimeId}`;
      }

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "/login.html";
      }
    </script>
  </body>
</html>
