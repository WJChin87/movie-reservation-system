<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Movie Showtimes - Movie Reservation System</title>
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      .movie-header {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .movie-poster {
        width: 200px;
        height: 300px;
        object-fit: cover;
        border-radius: 4px;
        flex-shrink: 0;
      }

      .movie-info {
        flex-grow: 1;
      }

      .movie-info h1 {
        margin: 0 0 10px 0;
        color: #333;
      }

      .movie-details {
        color: #666;
      }

      .movie-description {
        margin-top: 15px;
        line-height: 1.6;
        color: #444;
      }

      .dates-container {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        overflow-x: auto;
        padding-bottom: 10px;
      }

      .date-button {
        min-width: 120px;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s ease;
      }

      .date-button:hover {
        border-color: #007bff;
        background: #f8f9fa;
      }

      .date-button.active {
        border-color: #007bff;
        background: #007bff;
      }

      .date-button.active .day,
      .date-button.active .date {
        color: white;
      }

      .date-button .day {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 5px;
        color: #333;
      }

      .date-button .date {
        font-size: 0.9em;
        color: #666;
      }

      .showtimes-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
      }

      .showtime-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background: white;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .showtime-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .theater-name {
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
      }

      .theater-type {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 10px;
      }

      .time-price {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .time {
        font-size: 1.2em;
        font-weight: bold;
        color: #007bff;
      }

      .price {
        color: #28a745;
        font-weight: bold;
      }

      .no-showtimes {
        text-align: center;
        padding: 20px;
        color: #666;
        font-style: italic;
        grid-column: 1 / -1;
      }

      .times {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
      }

      .time-button {
        padding: 8px 12px;
        border: 1px solid #007bff;
        border-radius: 4px;
        background: white;
        color: #007bff;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s ease;
      }

      .time-button:hover {
        background: #007bff;
        color: white;
      }

      /* Scrollbar styling */
      .dates-container::-webkit-scrollbar {
        height: 8px;
      }

      .dates-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .dates-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }

      .dates-container::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <nav class="nav-links">
        <a href="/movies.html">Movies</a>
        <a href="/reservations.html">My Reservations</a>
        <button onclick="logout()" class="logout-btn">Logout</button>
      </nav>

      <div id="movieHeader" class="movie-header"></div>
      <div id="datesContainer" class="dates-container"></div>
      <div id="showtimesContainer" class="showtimes-container"></div>
    </div>

    <script>
      const API_URL = "http://localhost:3000/api";
      const authToken = localStorage.getItem("token");
      let currentMovie = null;
      let allShowtimes = [];

      // Check authentication
      if (!authToken) {
        window.location.href = "/login.html";
      }

      // Get movie ID and title from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const movieId = urlParams.get("movieId");
      const movieTitle = urlParams.get("title");

      if (!movieId || !movieTitle) {
        window.location.href = "/movies.html";
      }

      document.addEventListener("DOMContentLoaded", initialize);

      async function initialize() {
        try {
          // Load movie details
          const movieResponse = await fetch(`${API_URL}/movies/${movieId}`, {
            headers: { Authorization: `Bearer ${authToken}` },
          });
          currentMovie = await movieResponse.json();

          // Mock showtime data (until the backend is ready)
          const today = new Date();
          const endDate = new Date();
          endDate.setDate(today.getDate() + 7);

          // Generate mock showtimes for the next 7 days
          allShowtimes = generateMockShowtimes(today, endDate);

          renderMovieHeader();
          renderDates();
          renderShowtimes(new Date().toISOString().split("T")[0]); // Show today's showtimes by default
        } catch (error) {
          console.error("Error initializing page:", error);
        }
      }

      function renderMovieHeader() {
        const header = document.getElementById("movieHeader");
        header.innerHTML = `
          <img src="${currentMovie.poster_url}" alt="${
          currentMovie.title
        }" class="movie-poster">
          <div class="movie-info">
            <h1>${currentMovie.title}</h1>
            <div class="movie-details">
              <p><strong>Duration:</strong> ${currentMovie.duration} minutes</p>
              <p><strong>Genre:</strong> ${currentMovie.genres
                .map((g) => g.name)
                .join(", ")}</p>
              <p><strong>Rating:</strong> ${currentMovie.rating}</p>
              <div class="movie-description">
                <p>${currentMovie.description}</p>
              </div>
            </div>
          </div>
        `;
      }

      function renderDates() {
        const dates = [];
        const today = new Date();

        // Generate next 7 days
        for (let i = 0; i < 7; i++) {
          const date = new Date(today);
          date.setDate(today.getDate() + i);
          dates.push(date);
        }

        const container = document.getElementById("datesContainer");
        container.innerHTML = dates
          .map((date) => {
            const isToday = date.toDateString() === today.toDateString();
            const dateStr = date.toISOString().split("T")[0];
            const dayNames = [
              "Sunday",
              "Monday",
              "Tuesday",
              "Wednesday",
              "Thursday",
              "Friday",
              "Saturday",
            ];
            return `
              <button 
                class="date-button ${isToday ? "active" : ""}" 
                onclick="renderShowtimes('${dateStr}')"
                data-date="${dateStr}"
              >
                <div class="day">${dayNames[date.getDay()]}</div>
                <div class="date">${date.toLocaleDateString()}</div>
              </button>
            `;
          })
          .join("");
      }

      function renderShowtimes(selectedDate) {
        // Update active date button
        document.querySelectorAll(".date-button").forEach((button) => {
          button.classList.toggle(
            "active",
            button.dataset.date === selectedDate
          );
        });

        // Filter showtimes for selected date
        const dateShowtimes = allShowtimes.filter((showtime) => {
          const showtimeDate = new Date(showtime.start_time)
            .toISOString()
            .split("T")[0];
          return showtimeDate === selectedDate;
        });

        // Group showtimes by theater type
        const theaterTypeShowtimes = {};
        dateShowtimes.forEach((showtime) => {
          const type = showtime.theater.type;
          if (!theaterTypeShowtimes[type]) {
            theaterTypeShowtimes[type] = {};
          }
          if (!theaterTypeShowtimes[type][showtime.theater.name]) {
            theaterTypeShowtimes[type][showtime.theater.name] = [];
          }
          theaterTypeShowtimes[type][showtime.theater.name].push(showtime);
        });

        const container = document.getElementById("showtimesContainer");

        if (dateShowtimes.length === 0) {
          container.innerHTML = `
            <div class="no-showtimes">
              No showtimes available for this date.
            </div>
          `;
          return;
        }

        container.innerHTML = Object.entries(theaterTypeShowtimes)
          .map(
            ([type, theaters]) => `
            <div class="theater-type-section" style="grid-column: 1 / -1;">
              <h2 style="margin-bottom: 15px; color: #333;">${type}</h2>
              <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
                ${Object.entries(theaters)
                  .map(
                    ([theater, showtimes]) => `
                    <div class="showtime-card">
                      <div class="theater-name">${theater}</div>
                      <div class="times">
                        ${showtimes
                          .map((showtime) => {
                            const time = new Date(
                              showtime.start_time
                            ).toLocaleTimeString([], {
                              hour: "2-digit",
                              minute: "2-digit",
                            });
                            return `
                              <button 
                                onclick="selectShowtime(${showtime.id})" 
                                class="time-button"
                              >
                                ${time}
                              </button>
                            `;
                          })
                          .join("")}
                      </div>
                      <div class="price">$${showtimes[0].price.toFixed(2)}</div>
                    </div>
                  `
                  )
                  .join("")}
              </div>
            </div>
          `
          )
          .join("");
      }

      function selectShowtime(showtimeId) {
        window.location.href = `/seats.html?showtimeId=${showtimeId}`;
      }

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "/login.html";
      }

      function generateMockShowtimes(startDate, endDate) {
        const showtimes = [];
        const theaters = [
          { id: 1, name: "IMAX Hall", type: "IMAX", price: 18.99 },
          { id: 2, name: "VIP Hall", type: "VIP", price: 24.99 },
          { id: 3, name: "Standard Hall 1", type: "Standard", price: 12.99 },
          { id: 4, name: "Standard Hall 2", type: "Standard", price: 12.99 },
        ];

        const showTimes = ["10:00", "13:00", "16:00", "19:00", "22:00"];
        let id = 1;

        for (
          let d = new Date(startDate);
          d <= endDate;
          d.setDate(d.getDate() + 1)
        ) {
          theaters.forEach((theater) => {
            showTimes.forEach((time) => {
              const [hours, minutes] = time.split(":");
              const startTime = new Date(d);
              startTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

              // Only add future showtimes
              if (startTime > new Date()) {
                showtimes.push({
                  id: id++,
                  movie_id: parseInt(movieId),
                  theater: {
                    id: theater.id,
                    name: theater.name,
                    type: theater.type,
                  },
                  start_time: startTime.toISOString(),
                  price: theater.price,
                });
              }
            });
          });
        }

        return showtimes;
      }
    </script>
  </body>
</html>
