<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Reservations - Movie Reservation System</title>
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      .reservation-card {
        display: flex;
        border: 1px solid #ddd;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        background: white;
        gap: 20px;
      }
      .movie-poster {
        flex-shrink: 0;
        width: 150px;
        height: 225px;
        border-radius: 4px;
        overflow: hidden;
      }
      .movie-poster img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .reservation-content {
        flex-grow: 1;
      }
      .reservation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }
      .reservation-status {
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.9em;
      }
      .status-active {
        background: #d4edda;
        color: #155724;
      }
      .status-cancelled {
        background: #f8d7da;
        color: #721c24;
      }
      .reservation-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }
      .detail-item {
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
      }
      .detail-label {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 5px;
      }
      .seats-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }
      .seat-tag {
        background: #e9ecef;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.9em;
      }
      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s;
      }
      .cancel-btn {
        background-color: #dc3545;
        color: white;
      }
      .cancel-btn:hover {
        background-color: #c82333;
      }
      .delete-btn {
        background-color: #6c757d;
        color: white;
      }
      .delete-btn:hover {
        background-color: #5a6268;
      }
      .update-btn {
        background-color: #007bff;
        color: white;
      }
      .update-btn:hover {
        background-color: #0056b3;
      }
      .no-reservations {
        text-align: center;
        padding: 40px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Movie Reservation System</h2>
      <nav class="nav-links">
        <a href="/movies.html">Movies</a>
        <a href="/reservations.html">My Reservations</a>
        <button onclick="logout()" class="logout-btn">Logout</button>
      </nav>

      <h3>My Reservations</h3>
      <div id="reservationsList"></div>
      <div id="message"></div>
    </div>

    <script>
      const API_URL = "http://localhost:3000/api";

      // Load reservations when page loads
      document.addEventListener("DOMContentLoaded", loadReservations);

      async function loadReservations() {
        try {
          const token = localStorage.getItem("token");
          if (!token) {
            showMessage("Please log in to view your reservations", "error");
            setTimeout(() => {
              window.location.href = "/login.html";
            }, 2000);
            return;
          }

          const response = await fetch(`${API_URL}/reservations`, {
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) {
            if (response.status === 401) {
              showMessage("Session expired. Please log in again.", "error");
              localStorage.removeItem("token");
              localStorage.removeItem("user");
              setTimeout(() => {
                window.location.href = "/login.html";
              }, 2000);
              return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const reservations = await response.json();
          const reservationsList = document.getElementById("reservationsList");

          if (!Array.isArray(reservations)) {
            throw new Error("Invalid response format");
          }

          if (reservations.length === 0) {
            reservationsList.innerHTML = `
              <div class="no-reservations">
                <h4>No Reservations Found</h4>
                <p>You haven't made any reservations yet.</p>
                <a href="/movies.html" class="btn">Browse Movies</a>
              </div>
            `;
            return;
          }

          reservationsList.innerHTML = reservations
            .map((reservation) => {
              const seats = Array.isArray(reservation.seats)
                ? reservation.seats
                : [];
              const totalPrice = (reservation.price * seats.length).toFixed(2);
              const showtime = new Date(reservation.start_time);
              const isUpcoming = showtime > new Date();

              return `
                <div class="reservation-card">
                  <div class="movie-poster">
                    <img src="${
                      reservation.movie_poster ||
                      "https://via.placeholder.com/150x225.png?text=No+Poster"
                    }" 
                         alt="${reservation.movie_title} Poster"
                         onerror="this.src='https://via.placeholder.com/150x225.png?text=No+Poster'">
                  </div>
                  <div class="reservation-content">
                    <div class="reservation-header">
                      <h4>${reservation.movie_title}</h4>
                      <span class="reservation-status status-${(
                        reservation.status || ""
                      ).toLowerCase()}">
                        ${reservation.status || "UNKNOWN"}
                      </span>
                    </div>
                    <div class="reservation-details">
                      <div class="detail-item">
                        <div class="detail-label">Date & Time</div>
                        <div>${showtime.toLocaleString()}</div>
                      </div>
                      <div class="detail-item">
                        <div class="detail-label">Theater</div>
                        <div>${
                          reservation.theater_name || "Not specified"
                        }</div>
                      </div>
                      <div class="detail-item">
                        <div class="detail-label">Seats</div>
                        <div class="seats-list">
                          ${
                            seats.length > 0
                              ? seats
                                  .map(
                                    (seat) =>
                                      `<span class="seat-tag">Row ${seat.row_number} - Seat ${seat.seat_number}</span>`
                                  )
                                  .join("")
                              : '<span class="seat-tag">No seats assigned</span>'
                          }
                        </div>
                      </div>
                      <div class="detail-item">
                        <div class="detail-label">Total Price</div>
                        <div>$${totalPrice}</div>
                      </div>
                    </div>
                    ${
                      isUpcoming
                        ? `
                      <div class="action-buttons">
                        ${
                          reservation.status === "ACTIVE"
                            ? `
                          <button onclick="updateReservation(${reservation.showtime_id}, 'CANCELLED')" class="btn cancel-btn">
                            Cancel Reservation
                          </button>
                        `
                            : reservation.status === "CANCELLED"
                            ? `
                          <button onclick="updateReservation(${reservation.showtime_id}, 'ACTIVE')" class="btn update-btn">
                            Reactivate Reservation
                          </button>
                        `
                            : ""
                        }
                        <button onclick="deleteReservation(${
                          reservation.showtime_id
                        })" class="btn delete-btn">
                          Delete Reservation
                        </button>
                      </div>
                    `
                        : ""
                    }
                  </div>
                </div>
              `;
            })
            .join("");
        } catch (error) {
          console.error("Error:", error);
          showMessage(error.message || "Error loading reservations", "error");
        }
      }

      async function updateReservation(showtimeId, newStatus) {
        if (
          !confirm(
            `Are you sure you want to ${
              newStatus === "CANCELLED" ? "cancel" : "reactivate"
            } this reservation?`
          )
        ) {
          return;
        }

        try {
          const token = localStorage.getItem("token");
          if (!token) {
            showMessage("Please log in to update reservations", "error");
            setTimeout(() => {
              window.location.href = "/login.html";
            }, 2000);
            return;
          }

          const response = await fetch(
            `${API_URL}/reservations/showtime/${showtimeId}`,
            {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ status: newStatus }),
            }
          );

          if (!response.ok) {
            if (response.status === 401) {
              showMessage("Session expired. Please log in again.", "error");
              localStorage.removeItem("token");
              localStorage.removeItem("user");
              setTimeout(() => {
                window.location.href = "/login.html";
              }, 2000);
              return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          showMessage(
            `Reservation ${
              newStatus === "CANCELLED" ? "cancelled" : "reactivated"
            } successfully`,
            "success"
          );
          await loadReservations();
        } catch (error) {
          console.error("Error:", error);
          showMessage(
            error.message ||
              `Error ${
                newStatus === "CANCELLED" ? "cancelling" : "reactivating"
              } reservation`,
            "error"
          );
        }
      }

      async function deleteReservation(showtimeId) {
        if (
          !confirm(
            "Are you sure you want to delete this reservation? This action cannot be undone."
          )
        ) {
          return;
        }

        try {
          const token = localStorage.getItem("token");
          if (!token) {
            showMessage("Please log in to delete reservations", "error");
            setTimeout(() => {
              window.location.href = "/login.html";
            }, 2000);
            return;
          }

          const response = await fetch(
            `${API_URL}/reservations/showtime/${showtimeId}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            if (response.status === 401) {
              showMessage("Session expired. Please log in again.", "error");
              localStorage.removeItem("token");
              localStorage.removeItem("user");
              setTimeout(() => {
                window.location.href = "/login.html";
              }, 2000);
              return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          showMessage("Reservation deleted successfully", "success");
          await loadReservations();
        } catch (error) {
          console.error("Error:", error);
          showMessage(error.message || "Error deleting reservation", "error");
        }
      }

      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "/login.html";
      }

      function showMessage(message, type) {
        const messageDiv = document.getElementById("message");
        messageDiv.textContent = message;
        messageDiv.className = type;
        setTimeout(() => {
          messageDiv.textContent = "";
          messageDiv.className = "";
        }, 5000);
      }
    </script>
  </body>
</html>
